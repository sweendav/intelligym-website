name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Create config file with environment variables
      run: |
        cat > config.local.js << EOF
        const config = {
          supabase: {
            url: '${{ secrets.SUPABASE_URL }}',
            anonKey: '${{ secrets.SUPABASE_ANON_KEY }}'
          },
          app: {
            name: 'IntelliGym',
            tagline: 'Your AI-Powered Workout Companion',
            domain: '${{ secrets.APP_DOMAIN || 'www.intelligym.app' }}',
            mobileAppScheme: 'intelligym://'
          },
          email: {
            redirectTo: '${{ secrets.EMAIL_REDIRECT_URL || 'https://www.intelligym.app' }}',
            resetPasswordRedirect: '${{ secrets.RESET_PASSWORD_REDIRECT_URL || 'https://www.intelligym.app/redirect.html' }}'
          }
        };
        window.IntelliGymLocalConfig = config;
        EOF
        echo "Config file created successfully"
        echo "Supabase URL: ${{ secrets.SUPABASE_URL }}"
        echo "Config file contents (without keys):"
        cat config.local.js | sed 's/anonKey:.*/anonKey: [HIDDEN]/'
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4 